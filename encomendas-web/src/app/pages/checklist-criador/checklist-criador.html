<div class="page-container">

  <div class="header-action">
    <h1>Gestão de Checklists</h1>
    <button mat-raised-button color="primary" (click)="showNovoBoardForm = !showNovoBoardForm">
      <mat-icon>add</mat-icon> Novo Quadro
    </button>
  </div>

  <div class="novo-board-container mat-elevation-z2" *ngIf="showNovoBoardForm">
    <h3>Criar Novo Quadro</h3>
    <div class="form-row">
      <mat-form-field appearance="outline">
        <mat-label>Nome do Quadro (Ex: Rotina Matinal)</mat-label>
        <input matInput [(ngModel)]="novoBoard.nome">
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Atribuir a Funcionário (Opcional)</mat-label>
        <mat-select [(ngModel)]="novoBoard.usuarioId">
          <mat-option [value]="null">-- Geral (Toda a Equipe) --</mat-option>
          <mat-option *ngFor="let m of membros" [value]="m.id">
            {{ m.nomeCompleto }}
          </mat-option>
        </mat-select>
        <mat-hint>Deixe vazio para ser visível a todos</mat-hint>
      </mat-form-field>

      <button mat-flat-button color="accent" (click)="criarBoard()" [disabled]="!novoBoard.nome">
        Salvar
      </button>
    </div>
  </div>

  <div class="loading-shade" *ngIf="loading">
    <p>A carregar processos...</p>
  </div>

  <mat-accordion multi>
    <mat-expansion-panel *ngFor="let board of boards" class="board-panel">

      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon class="panel-icon">dashboard</mat-icon>
          {{ board.nome }}
        </mat-panel-title>
        <mat-panel-description>
          <span class="tag-owner" *ngIf="board.usuarioEspecificoId">
            <mat-icon>person</mat-icon> {{ getNomeResponsavel(board.usuarioEspecificoId) }}
          </span>
          <span class="tag-general" *ngIf="!board.usuarioEspecificoId">
            <mat-icon>groups</mat-icon> Equipe Geral
          </span>
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="cards-grid">

        <mat-card *ngFor="let card of board.cards" class="checklist-card">
          <mat-card-header>
            <mat-card-title>{{ card.titulo }}</mat-card-title>
            <mat-card-subtitle>
              {{ card.horarioAbertura }} - {{ card.horarioFechamento }}
            </mat-card-subtitle>
          </mat-card-header>

          <mat-divider></mat-divider>

          <mat-card-content>
            <div class="item-list">
              <div class="item-row" *ngFor="let item of card.itens">
                <mat-icon class="bullet">check_small</mat-icon>
                <span>{{ item.descricao }}</span>
              </div>
              <div *ngIf="!card.itens?.length" class="empty-items">Sem itens ainda.</div>
            </div>

            <div class="add-item-box">
              <input #newItemInput placeholder="Novo item..." (keyup.enter)="adicionarItem(card, newItemInput.value); newItemInput.value=''">
              <button mat-icon-button color="primary" (click)="adicionarItem(card, newItemInput.value); newItemInput.value=''">
                <mat-icon>add_circle</mat-icon>
              </button>
            </div>
          </mat-card-content>
        </mat-card>

        <div class="new-card-placeholder">
          <h4>Adicionar Tarefa/Cartão</h4>
          <mat-form-field appearance="fill" class="full-width">
            <mat-label>Título</mat-label>
            <input matInput #newCardTitle>
          </mat-form-field>

          <div class="time-inputs">
            <mat-form-field appearance="fill">
              <mat-label>Início</mat-label>
              <input matInput type="time" #newCardStart value="08:00">
            </mat-form-field>
            <mat-form-field appearance="fill">
              <mat-label>Fim</mat-label>
              <input matInput type="time" #newCardEnd value="18:00">
            </mat-form-field>
          </div>

          <button mat-stroked-button color="primary"
                  (click)="adicionarCard(board, newCardTitle.value, newCardStart.value, newCardEnd.value); newCardTitle.value=''">
            <mat-icon>save</mat-icon> Criar Tarefa
          </button>
        </div>

      </div>

    </mat-expansion-panel>
  </mat-accordion>

  <div *ngIf="!loading && boards.length === 0" class="empty-state">
    <mat-icon>playlist_add</mat-icon>
    <h3>Nenhum quadro de checklist encontrado.</h3>
    <p>Crie o primeiro para organizar a rotina.</p>
  </div>
</div>
