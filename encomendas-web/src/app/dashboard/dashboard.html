<div class="dashboard-container">

  <div class="mobile-stack" *ngIf="isMobile">

    <mat-card class="stat-card">
      <mat-card-content>
        <div style="display: flex; justify-content: space-between;">
          <div><p>Bruto (30d)</p><h3>{{ (totalBrutoMes$ | async) | currency:'BRL' }}</h3></div>
          <div class="text-right"><p>Líquido</p><h3 class="primary-text">{{ (totalLiquidoMes$ | async) | currency:'BRL' }}</h3></div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="status-grid">
          <div class="status-item warn">
            <div class="value-group"><span class="count">{{ (statusCounts$ | async)?.criada }}</span></div>
            <span class="desc">Criadas</span>
          </div>
          <div class="status-item accent">
            <div class="value-group"><span class="count">{{ (statusCounts$ | async)?.loja }}</span></div>
            <span class="desc">Na Loja</span>
          </div>
          <div class="status-item primary">
            <div class="value-group"><span class="count">{{ (statusCounts$ | async)?.aguardando }}</span></div>
            <span class="desc">Aguardando</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px;">
      <button mat-raised-button color="primary" routerLink="/encomenda-create" class="full-width-btn">
        <mat-icon>add</mat-icon> Nova Encomenda
      </button>
      <button mat-stroked-button color="primary" routerLink="/encomendas" class="full-width-btn">
        <mat-icon>list_alt</mat-icon> Gerenciar Encomendas
      </button>
    </div>

    <mat-card class="table-card" *ngIf="(encomendasAtrasadas$ | async)?.length">
      <mat-card-header><mat-card-title style="color: #f44336;">⚠ Atrasadas</mat-card-title></mat-card-header>
      <mat-card-content>
        <mat-list dense>
          <mat-list-item *ngFor="let e of (encomendasAtrasadas$ | async)" (click)="verDetalhes(e)">
            <span matListItemIcon style="color: #f44336;"><mat-icon>priority_high</mat-icon></span>
            <h3 matListItemTitle>{{e.cliente.nome}}</h3>
            <p matListItemLine>Previsto: {{e.dataEstimadaEntrega | date:'dd/MM HH:mm'}}</p>
          </mat-list-item>
        </mat-list>
      </mat-card-content>
    </mat-card>

    <mat-card class="table-card">
      <mat-card-header><mat-card-title>Últimas Abertas</mat-card-title></mat-card-header>
      <mat-card-content>
        <mat-list dense>
          <mat-list-item *ngFor="let e of (ultimasEncomendasAbertas$ | async)" (click)="verDetalhes(e)">
            <span matListItemIcon><mat-icon>receipt</mat-icon></span>
            <h3 matListItemTitle>{{e.cliente.nome}}</h3>
            <p matListItemLine>{{e.status}} • {{e.valorTotal | currency:'BRL'}}</p>
          </mat-list-item>
        </mat-list>
      </mat-card-content>
    </mat-card>
  </div>


  <div class="desktop-grid" *ngIf="!isMobile">

    <mat-grid-list cols="4" rowHeight="fit" gutterSize="12px">

      <mat-grid-tile colspan="1" rowspan="1">
        <mat-card class="stat-card">
          <mat-card-header><mat-card-title><mat-icon>attach_money</mat-icon> Bruto (30d)</mat-card-title></mat-card-header>
          <mat-card-content>
            <h2>{{ (totalBrutoMes$ | async) | currency:'BRL' }}</h2>
            <p>{{ (contagemPedidosMes$ | async) }} pedidos ativos</p>
          </mat-card-content>
        </mat-card>
      </mat-grid-tile>

      <mat-grid-tile colspan="1" rowspan="1">
        <mat-card class="stat-card">
          <mat-card-header><mat-card-title><mat-icon>savings</mat-icon> Líquido (30d)</mat-card-title></mat-card-header>
          <mat-card-content>
            <h2 class="primary-text">{{ (totalLiquidoMes$ | async) | currency:'BRL' }}</h2>
            <p>Concluídos</p>
          </mat-card-content>
        </mat-card>
      </mat-grid-tile>

      <mat-grid-tile colspan="1" rowspan="1">
        <mat-card class="stat-card">
          <mat-card-header><mat-card-title><mat-icon>trending_up</mat-icon> Ticket Médio</mat-card-title></mat-card-header>
          <mat-card-content>
            <h2>{{ (ticketMedio$ | async) | currency:'BRL' }}</h2>
            <p>por pedido</p>
          </mat-card-content>
        </mat-card>
      </mat-grid-tile>

      <mat-grid-tile colspan="1" rowspan="1">
        <mat-card class="stat-card info-card">
          <mat-card-content class="shortcuts-content" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; height: 100%;">

            <button mat-flat-button color="primary" routerLink="/encomenda-create" style="width: 100%; height: 48px; font-size: 1rem;">
              <mat-icon style="margin-right: 8px;">add_shopping_cart</mat-icon>
              Nova Encomenda
            </button>

            <button mat-stroked-button color="primary" routerLink="/encomendas" style="width: 100%; height: 48px; font-size: 1rem;">
              <mat-icon style="margin-right: 8px;">list_alt</mat-icon>
              Gerenciar Encomendas
            </button>

          </mat-card-content>
        </mat-card>
      </mat-grid-tile>


      <mat-grid-tile colspan="3" rowspan="1">
        <mat-card class="stat-card funnel-card">
          <div class="funnel-container">

            <div class="funnel-step warn">
              <div class="icon-num-group">
                <mat-icon>pending</mat-icon>
                <span class="count">{{ (statusCounts$ | async)?.criada }}</span>
              </div>
              <span class="label">Criadas</span>
            </div>

            <mat-icon class="funnel-arrow">arrow_forward</mat-icon>

            <div class="funnel-step accent">
              <div class="icon-num-group">
                <mat-icon>store</mat-icon>
                <span class="count">{{ (statusCounts$ | async)?.loja }}</span>
              </div>
              <span class="label">Na Loja</span>
            </div>

            <mat-icon class="funnel-arrow">arrow_forward</mat-icon>

            <div class="funnel-step primary">
              <div class="icon-num-group">
                <mat-icon>local_shipping</mat-icon>
                <span class="count">{{ (statusCounts$ | async)?.aguardando }}</span>
              </div>
              <span class="label">Aguardando</span>
            </div>

            <div class="vertical-divider"></div>

            <div class="funnel-step success">
              <div class="icon-num-group">
                <mat-icon>check_circle</mat-icon>
                <span class="count">{{ (statusCounts$ | async)?.concluido }}</span>
              </div>
              <span class="label">Concluídos</span>
            </div>

          </div>
        </mat-card>
      </mat-grid-tile>

      <mat-grid-tile colspan="1" rowspan="2">
        <mat-card class="table-card scrollable-card" style="border: 1px solid #ffebee;">
          <mat-card-header>
            <mat-card-title style="color: #d32f2f; display: flex; align-items: center; gap: 8px;">
              <mat-icon>warning</mat-icon> Atrasadas
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <mat-list dense>
              <mat-list-item *ngFor="let e of (encomendasAtrasadas$ | async)" (click)="verDetalhes(e)" style="cursor: pointer; border-bottom: 1px solid #eee;">
                <span matListItemIcon style="color: #d32f2f;"><mat-icon>priority_high</mat-icon></span>
                <span matListItemTitle>{{e.cliente.nome}}</span>
                <span matListItemLine style="color: #d32f2f;">
                  {{e.dataEstimadaEntrega | date:'dd/MM HH:mm'}}
                </span>
              </mat-list-item>

              <div *ngIf="(encomendasAtrasadas$ | async)?.length === 0" class="empty-state" style="color: #4caf50;">
                <mat-icon style="font-size: 32px; height: 32px; width: 32px; margin-bottom: 8px;">check</mat-icon>
                <p>Tudo em dia!</p>
              </div>
            </mat-list>
          </mat-card-content>
        </mat-card>
      </mat-grid-tile>


      <mat-grid-tile colspan="3" rowspan="1">
        <mat-card class="table-card">
          <mat-card-header class="header-with-button">
            <mat-card-title>Últimos Pedidos</mat-card-title>
            <button mat-button color="primary" (click)="irParaEncomendas()">Ver Todos</button>
          </mat-card-header>

          <mat-card-content class="table-responsive-container">
            <table mat-table [dataSource]="(ultimasEncomendasAbertas$ | async) || []" class="mat-elevation-z0 full-width-table">

              <ng-container matColumnDef="data">
                <th mat-header-cell *matHeaderCellDef> Data </th>
                <td mat-cell *matCellDef="let e"> {{e.dataCriacao | date:'dd/MM HH:mm'}} </td>
              </ng-container>

              <ng-container matColumnDef="cliente">
                <th mat-header-cell *matHeaderCellDef> Cliente </th>
                <td mat-cell *matCellDef="let e"> {{e.cliente.nome}} </td>
              </ng-container>

              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef> Status </th>
                <td mat-cell *matCellDef="let e">
                  <mat-chip [color]="getStatusColor(e.status)" selected class="small-chip">{{e.status}}</mat-chip>
                </td>
              </ng-container>

              <ng-container matColumnDef="valorTotal">
                <th mat-header-cell *matHeaderCellDef> Total </th>
                <td mat-cell *matCellDef="let e" style="font-weight: 500;"> {{e.valorTotal | currency:'BRL'}} </td>
              </ng-container>

              <ng-container matColumnDef="acoes">
                <th mat-header-cell *matHeaderCellDef></th>
                <td mat-cell *matCellDef="let e">
                  <button mat-icon-button color="primary" class="small-icon-btn" (click)="verDetalhes(e)">
                    <mat-icon>visibility</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="hover-row"></tr>
            </table>
          </mat-card-content>
        </mat-card>
      </mat-grid-tile>

    </mat-grid-list>
  </div>
</div>
